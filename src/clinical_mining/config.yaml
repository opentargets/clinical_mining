# =================================================
# PIPELINE CONFIGURATION
# =================================================

# Database Connection Properties
db_properties:
  aact:
    type: postgresql
    uri: localhost:5432/aact # aact-db.ctti-clinicaltrials.org:5432/aact
    schema: ctgov
    user: null
    password: null
  
  chembl:
    type: oracle
    host: ora-vm-089
    port: 1531
    service: CHEMPRO
    user: null
    password: null
    oracle_client_path: /opt/oracle/instantclient_23_3

# Path Definitions for Local Datasets
datasets:
  chembl_indications_path: ${oc.env:HOME}/EBI/repos/clinical_mining/data/inputs/chembl_drug_indication.jsonl # ???
  disease_index_path: ${oc.env:HOME}/EBI/repos/clinical_mining/data/inputs/disease # null
  drug_index_path: ${oc.env:HOME}/EBI/repos/clinical_mining/data/inputs/drug_molecule # null
  ttd_path: ${oc.env:HOME}/EBI/repos/clinical_mining/data/inputs/P1-05-Drug_disease.txt # null
  ema_path: ${oc.env:HOME}/EBI/repos/clinical_mining/data/inputs/medicines-output-medicines-report_en.xlsx # null
  output_path: ${oc.env:HOME}/EBI/repos/clinical_mining/data/outputs/clinical_trials # ???

# Input Data Sources - Each key becomes the name of a DataFrame available to the pipeline steps.
inputs:
  chembl_indications_raw:
    format: json
    path: ${datasets.chembl_indications_path}
  drug_index_spark:
    format: parquet
    path: ${datasets.drug_index_path}
  disease_index_spark:
    format: parquet
    path: ${datasets.disease_index_path}

  studies:
    format: db_table
    select_cols:
      - nct_id
      - overall_status
      - phase
      - study_type
      - completion_date
      - why_stopped
      - number_of_arms
  interventions:
    format: db_table
    select_cols:
      - nct_id
      - intervention_type
      - name
  conditions:
    format: db_table
    select_cols:
      - nct_id
      - downcase_name
  study_references:
    format: db_table
    select_cols:
      - nct_id
      - pmid
      - reference_type
  designs:
    format: db_table
    select_cols:
      - nct_id
      - primary_purpose
  brief_summaries:
    format: db_table
    select_cols:
      - nct_id
      - description

# =============================
# PIPELINE DEFINITION
# =============================

pipeline:
  # SETUP: Steps to prepare data needed by later stages (e.g., loading mapping tables).
  setup:
    - name: chembl_curation
      function: clinical_mining.data_sources.chembl.curation.extract_chembl_ct_curation
      parameters:
        db_host: ${db_properties.chembl.host}
        db_port: ${db_properties.chembl.port}
        db_service: ${db_properties.chembl.service}
        db_user: ${db_properties.chembl.user}
        db_password: ${db_properties.chembl.password}
        oracle_client_path: ${db_properties.chembl.oracle_client_path}
    - name: trials
      function: clinical_mining.data_sources.aact.extract_clinical_trials
      parameters:
        studies: $studies
        additional_metadata: ['$study_references', '$designs', '$brief_summaries']
        aggregation_specs: 
          pmid: 
            group_by: nct_id
            alias: literature

  # GENERATE: Steps that generate the core drug/indication DataFrames.
  generate:
    - name: aact_indications
      function: clinical_mining.data_sources.aact.extract_drug_indications
      parameters:
        interventions: $interventions
        conditions: $conditions
    - name: chembl_indications
      function: clinical_mining.data_sources.chembl.indications.extract_chembl_indications
      parameters:
        raw_indications: $chembl_indications_raw
        exclude_trials: true
    - name: ttd_indications
      function: clinical_mining.data_sources.ttd.extract_ttd_indications
      parameters:
        indications_path: ${datasets.ttd_path}
    - name: ema_indications
      function: clinical_mining.data_sources.ema.extract_ema_indications
      parameters:
        indications_path: ${datasets.ema_path}

  # POST-PROCESS: Final transformation steps that run sequentially on the unified `indications` DataFrame.
  post_process:
    - name: indications
      function: clinical_mining.utils.polars_helpers.union_dfs
      parameters:
        dfs: [$aact_indications, $chembl_indications, $ttd_indications, $ema_indications]
    - name: indications_w_metadata
      function: clinical_mining.utils.polars_helpers.join_dfs
      parameters:
        dfs: [$indications, $trials]
        join_on: studyId
        how: left
    - name: trials_mapped
      function: clinical_mining.utils.mapping.map_entities
      parameters:
        spark: $spark_session
        clinical_associations: $indications_w_metadata
        disease_index: $disease_index_spark
        drug_index: $drug_index_spark
        chembl_curation: $chembl_curation
        drug_column_name: drug_name
        disease_column_name: disease_name
    - name: approval_assessment
      function: clinical_mining.dataset.DrugIndicationEvidenceDataset.assign_approval_status
      parameters:
        indications: $trials_mapped
    - name: final_df
      function: clinical_mining.dataset.DrugIndicationDataset.from_evidence
      parameters:
        evidence: $approval_assessment
