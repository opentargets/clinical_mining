# =================================================
# PIPELINE CONFIGURATION
# =================================================

# Database Connection Properties
db_properties:
  aact:
    type: postgresql
    uri: localhost:5432/aact # aact-db.ctti-clinicaltrials.org:5432/aact
    schema: ctgov
    user: null
    password: null
  
  chembl:
    type: oracle
    host: ora-vm-089
    port: 1531
    service: CHEMPRO
    user: null
    password: null
    oracle_client_path: /opt/oracle/instantclient_23_3

# Path Definitions for Local Datasets
datasets:
  chembl_indications_path: ${oc.env:HOME}/EBI/repos/clinical_mining/data/inputs/chembl_drug_indication.jsonl # ???
  disease_path: ${oc.env:HOME}/EBI/repos/clinical_mining/data/inputs/disease # null
  molecule_path: ${oc.env:HOME}/EBI/repos/clinical_mining/data/inputs/drug_molecule # null
  output_path: ${oc.env:HOME}/EBI/repos/clinical_mining/data/outputs/clinical_trials # ???

# Input Data Sources - Each key becomes the name of a DataFrame available to the pipeline steps.
inputs:
  studies:
    type: db_table
    select_cols:
      - nct_id
      - overall_status
      - phase
      - study_type
      - completion_date
      - why_stopped
      - number_of_arms
  interventions:
    type: db_table
    select_cols:
      - nct_id
      - intervention_type
      - name
  conditions:
    type: db_table
    select_cols:
      - nct_id
      - downcase_name
  study_references:
    type: db_table
    select_cols:
      - nct_id
      - pmid
      - reference_type
  designs:
    type: db_table
    select_cols:
      - nct_id
      - primary_purpose
  brief_summaries:
    type: db_table
    select_cols:
      - nct_id
      - description
  chembl_indications_raw:
    type: file
    format: json
    path: ${datasets.chembl_indications_path}

# =============================
# PIPELINE DEFINITION
# =============================

pipeline:
  # SETUP: Steps to prepare data needed by later stages (e.g., loading mapping tables).
  setup:
    - name: molecule
      function: clinical_mining.utils.mapping.process_molecule
      parameters:
        path: ${datasets.molecule_path}
    - name: disease
      function: clinical_mining.utils.mapping.process_disease
      parameters:
        path: ${datasets.disease_path}
    - name: chembl_curation
      function: clinical_mining.data_sources.chembl.curation.extract_chembl_ct_curation
      parameters:
        db_host: ${db_properties.chembl.host}
        db_port: ${db_properties.chembl.port}
        db_service: ${db_properties.chembl.service}
        db_user: ${db_properties.chembl.user}
        db_password: ${db_properties.chembl.password}
        oracle_client_path: ${db_properties.chembl.oracle_client_path}
    - name: trials
      function: clinical_mining.data_sources.aact.aact.extract_clinical_trials
      parameters:
        studies: $studies
        additional_metadata: ['$study_references', '$designs', '$brief_summaries']

  # GENERATE: Steps that generate the core drug/indication DataFrames.
  generate:
    - name: aact_indications
      function: clinical_mining.data_sources.aact.aact.extract_drug_indications
      parameters:
        interventions: $interventions
        conditions: $conditions
    - name: chembl_indications
      function: clinical_mining.data_sources.chembl.indications.extract_chembl_indications
      parameters:
        raw_indications: $chembl_indications_raw
        exclude_trials: true

  # POST-PROCESS: Final transformation steps that run sequentially on the unified `indications` DataFrame.
  post_process:
    - name: indications
      function: clinical_mining.utils.polars_helpers.union_dfs
      parameters:
        dfs: [$aact_indications, $chembl_indications]
    - name: indications_w_metadata
      function: clinical_mining.utils.polars_helpers.join_dfs
      parameters:
        dfs: [$indications, $trials]
        join_on: studyId
        how: left
    - name: trials_mapped_drug
      function: clinical_mining.utils.mapping.assign_drug_id
      parameters:
        df: $indications_w_metadata
        molecule: $molecule
        chembl_curation: $chembl_curation
        verbose: false
    - name: trials_mapped_drug_disease
      function: clinical_mining.utils.mapping.assign_disease_id
      parameters:
        df: $trials_mapped_drug
        chembl_curation: $chembl_curation
        diseases: $disease
        verbose: false
    - name: approval_assessment
      function: clinical_mining.dataset.DrugIndicationEvidenceDataset.assign_approval_status
      parameters:
        indications: $trials_mapped_drug_disease
    - name: final_df
      function: clinical_mining.dataset.DrugIndicationDataset.from_evidence
      parameters:
        evidence: $approval_assessment
